<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>회원가입 페이지</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>

<body>
    <h1>회원가입 페이지</h1>

    <form action="/user/save" method="post">
        아이디: <input type="text" name="loginid" id="loginid" required>
        <button type="button" onclick="idCheck()">중복확인</button> <br />
        비밀번호: <input type="password" name="pw" required> <br />
        이름: <input type="text" name="name" required> <br />
        닉네임: <input type="text" name="nickname" id="nickname" required> 
        <button type="button" onclick="nicknameCheck()">중복확인</button> <br />
        주소: <input type="text" name="address" required> <br />
        이메일: <input type="email" name="email" id="email" required>
        <button type="button" onclick="emailCheck()">중복확인</button> <br />
        전화번호: <input type="text" name="tel" required> <br />
        Role:
        <select name="role" required>
            <option value="user">user</option>
            <option value="admin">admin</option>
            <option value="company">company</option>
        </select> <br />
        <input type="submit" id="submitBtn" value="회원가입" disabled>
    </form>
</body>

<script th:inline="javascript">
    let isIdValid = false; // 아이디 중복 확인 상태를 저장하는 변수
    let isEmailValid = false; // 이메일 중복 확인 상태를 저장하는 변수
    let isNicknameValid = false; // 닉네임 중복 확인 상태를 저장하는 변수

    const updateSubmitButtonState = () => {
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = !(isIdValid && isEmailValid && isNicknameValid); // 아이디와 이메일과 닉네임이 유효하지 않으면 버튼 비활성화
    };

    const idCheck = () => {
        const id = document.getElementById("loginid").value;
        console.log("입력값: ", id);
        $.ajax({
            // 요청방식 : post, url: "id-check", 데이터: 아이디
            type: "post",
            url: "/user/id-check",
            data: {
                "loginid": id
            },
            success: function (res) {
                console.log("요청성공", res);
                if (res == "ok") {
                    alert("사용가능한 아이디");
                    isIdValid = true; // 아이디가 유효함
                } else {
                    alert("이미 사용중인 아이디");
                    isIdValid = false; // 아이디가 유효하지 않음
                }
                updateSubmitButtonState(); // 제출 버튼 상태 업데이트
            },
            error: function (err) {
                console.log("에러발생", err);
            }
        });
    }

    const emailCheck = () => {
        const email = document.getElementById("email").value;
        console.log("입력값: ", email);
        $.ajax({
            // 요청방식 : post, url: "email-check", 데이터: 이메일
            type: "post",
            url: "/user/email-check",
            data: {
                "email": email
            },
            success: function (res) {
                console.log("요청성공", res);
                if (res == "ok") {
                    alert("사용가능한 이메일");
                    isEmailValid = true; // 이메일이 유효함
                } else {
                    alert("이미 사용중인 이메일");
                    isEmailValid = false; // 이메일이 유효하지 않음
                }
                updateSubmitButtonState(); // 제출 버튼 상태 업데이트
            },
            error: function (err) {
                console.log("에러발생", err);
            }
        });
    }
    
    const nicknameCheck = () => {
        const nickname = document.getElementById("nickname").value;
        console.log("입력값: ", nickname);
        $.ajax({
            // 요청방식 : post, url: "id-check", 데이터: 아이디
            type: "post",
            url: "/user/nickname-check",
            data: {
                "nickname": nickname
            },
            success: function (res) {
                console.log("요청성공", res);
                if (res == "ok") {
                    alert("사용가능한 닉네임");
                    isNicknameValid = true; // 닉네임이 유효함
                } else {
                    alert("이미 사용중인 닉네임");
                    isNicknameValid = false; // 닉네임이 유효하지 않음
                }
                updateSubmitButtonState(); // 제출 버튼 상태 업데이트
            },
            error: function (err) {
                console.log("에러발생", err);
            }
        });
    }

    document.getElementById("loginid").addEventListener("input", () => {
        isIdValid = false; // 아이디 입력이 변경될 때 유효 상태 초기화
        updateSubmitButtonState(); // 제출 버튼 상태 업데이트
    });

    document.getElementById("email").addEventListener("input", () => {
        isEmailValid = false; // 이메일 입력이 변경될 때 유효 상태 초기화
        updateSubmitButtonState(); // 제출 버튼 상태 업데이트
    });
    
    document.getElementById("nickname").addEventListener("input", () => {
        isNicknameValid = false; // 닉네임 입력이 변경될 때 유효 상태 초기화
        updateSubmitButtonState(); // 제출 버튼 상태 업데이트
    });
</script>

</html>
