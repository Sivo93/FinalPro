<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>채팅</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/chat.css"> <!-- 새로운 CSS 파일 링크 추가 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let senderNickname = /*[[${sender}]]*/ '[[${sender}]]';
        let receiverNickname = /*[[${receiver}]]*/ '[[${receiver}]]';

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, onConnected, onError);
        }

        function onConnected() {
            const roomId = generateRoomId(senderNickname, receiverNickname);
            stompClient.subscribe('/topic/' + roomId, onMessageReceived);
            stompClient.subscribe('/topic/chat-list/' + senderNickname, onChatListUpdate);
            loadChatHistory();
        }

        function onError(error) {
            console.error(error);
        }

        function sendMessage(event) {
            const messageContent = document.querySelector('#message-input').value.trim();
            if (messageContent && stompClient) {
                const chatMessage = {
                    sender: senderNickname,
                    receiver: receiverNickname,
                    content: messageContent,
                    timestamp: new Date().toISOString(),
                    type: 'CHAT'
                };
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                document.querySelector('#message-input').value = '';
            }
            event.preventDefault();
        }

        function onMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            displayMessage(message);
        }

        function onChatListUpdate(payload) {
            const chatRooms = JSON.parse(payload.body);
            const chatSidebar = document.querySelector('.chat-sidebar ul');
            chatSidebar.innerHTML = '';
            chatRooms.forEach(function(roomDto) {
                const user = roomDto.room.sender === senderNickname ? roomDto.room.receiver : roomDto.room.sender;
                const li = document.createElement('li');
                li.onclick = () => openChat(user);
                li.innerHTML = `<strong>${user}</strong><br><span>${roomDto.latestMessage}</span>`;
                chatSidebar.appendChild(li);
            });
        }

        function loadChatHistory() {
            $.get("/chat/messages", { sender: senderNickname, receiver: receiverNickname }, function(data) {
                data.forEach(function(message) {
                    displayMessage(message);
                });
            });
        }

        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');
            if (message.sender === senderNickname) {
                messageElement.classList.add('chat-message-right');
            } else {
                messageElement.classList.add('chat-message-left');
                const senderElement = document.createElement('strong');
                senderElement.textContent = message.sender;
                messageElement.appendChild(senderElement);
            }

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            const textElement = document.createElement('span');
            const messageText = document.createTextNode(message.content);
            textElement.appendChild(messageText);
            messageContent.appendChild(textElement);
            messageElement.appendChild(messageContent);

            const timestampElement = document.createElement('div');
            timestampElement.classList.add('timestamp');
            timestampElement.textContent = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageElement.appendChild(timestampElement);

            document.querySelector('#chat-messages').appendChild(messageElement);
            document.querySelector('#chat-messages').scrollTop = document.querySelector('#chat-messages').scrollHeight;
        }

        function loadChatRooms() {
            $.get("/chat/rooms", { username: senderNickname }, function(data) {
                onChatListUpdate({ body: JSON.stringify(data) });
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            connect();
            loadChatRooms();
            document.querySelector('#send-button').addEventListener('click', sendMessage, true);
        });

        function generateRoomId(sender, receiver) {
            return sender.localeCompare(receiver) > 0 ? sender + "_" + receiver : receiver + "_" + sender;
        }

        function openChat(receiver) {
            window.location.href = `/chat?sender=${encodeURIComponent(senderNickname)}&receiver=${encodeURIComponent(receiver)}`;
        }
    </script>
</head>
<body>
<div class="chat-container">
    <div class="chat-sidebar">
        <h2>채팅방 목록</h2>
        <ul></ul>
    </div>
    <div class="chat-main">
        <div class="chat-header">
            <h3 th:text="'채팅 상대: ' + ${receiver}"></h3>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-footer">
            <input type="text" id="message-input" placeholder="메시지 입력">
            <button id="send-button">전송</button>
        </div>
    </div>
</div>
</body>
</html>
